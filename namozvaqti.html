<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïå O'zbekiston Ramazon Taqvimi va Namoz Vaqtlari</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
    --color-primary: #008f5a;   /* Yashil (Asosiy) */
    --color-secondary: #FFC000; /* Oltin Sariq (Urg'u beruvchi) */
    --color-navy: #1f334a;      /* To'q Moviy (Fon) */
    --color-light: #FFFFFF;     /* Oq (Matn) */
    --color-bg-dark: #122033;   /* Chuqur Fon */
}

/* Global Uslublar (O'qishga qulaylik) */
body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 0;
    color: var(--color-light);
    background: linear-gradient(135deg, var(--color-navy) 0%, var(--color-bg-dark) 100%);
    min-height: 100vh;
    line-height: 1.8; /* Qatorlar oralig'ini oshirish */
    font-size: 18px; /* Asosiy shrift hajmini oshirish */
    /* Yangi: Silliq skroll */
    scroll-behavior: smooth; 
}

h1, h2, h3 {
    color: var(--color-secondary);
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
h2 { font-size: 2.2em; }
h3 { font-size: 1.8em; }

.container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 20px;
}

/* Glassmorphism/Karta Effekti (Tinch ranglarda) */
.glass-card {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 15px;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

/* Header va Navigatsiya */
header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 40px;
    background: var(--color-navy);
    box-shadow: 0 3px 5px rgba(0, 0, 0, 0.3);
    /* Yangi: Tepada qotirish */
    position: sticky; 
    top: 0; 
    z-index: 100; /* Boshqa elementlardan ustun turishi uchun */
}
.logo { font-size: 1.8em; }
nav a {
    color: var(--color-light);
    text-decoration: none;
    margin-left: 20px;
    font-weight: 600;
    font-size: 1.1em;
    padding: 5px 10px;
}
nav a:hover {
    color: var(--color-secondary);
}

/* Tugmalar va Forma Elementlari */
.btn {
    padding: 15px 30px; /* Kattaroq tugmalar */
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 1em;
    margin: 10px 10px 10px 0;
    display: inline-block;
}
.btn-primary {
    background-color: var(--color-primary);
    color: var(--color-navy);
}
.btn-telegram {
    background-color: #0088cc; /* Telegram ko'k */
    color: var(--color-light);
}
.dropdown {
    padding: 12px;
    border-radius: 8px;
    border: 1px solid var(--color-primary);
    background-color: rgba(255, 255, 255, 0.1);
    color: var(--color-light);
    font-size: 1em;
    cursor: pointer;
}
.dropdown option {
    background-color: var(--color-navy); /* Option fonini to'q qilish */
}

/* Modal Uslubi */
.modal {
    z-index: 1000;
}
.modal-content {
    max-width: 500px;
    text-align: center;
}
.large-text {
    font-size: 1.2em;
    font-weight: 600;
    color: var(--color-secondary);
}
.small-text {
    font-size: 0.85em;
    color: #aaa;
    margin-top: 15px;
}

/* Namoz Vaqtlari va Countdown */
.prayer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.location-control label {
    font-weight: 600;
    margin-right: 10px;
}
.countdown-timers {
    display: flex;
    gap: 25px;
    margin: 30px 0;
}
.large-timer {
    padding: 30px;
    flex: 1;
}
.countdown-display {
    font-size: 3.5em; /* Juda katta va aniq vaqt */
    color: var(--color-secondary);
    font-weight: 700;
    letter-spacing: 2px;
}

/* Umumiy Jadval Uslubi */
.simple-table, .wide-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    font-size: 1.1em; /* Jadvaldagi shrift kattaligi */
}
.simple-table th, .simple-table td, 
.wide-table th, .wide-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.simple-table th, .wide-table th {
    background-color: rgba(0, 143, 90, 0.2);
    color: var(--color-secondary);
    font-weight: 600;
}
.simple-table td:last-child {
    text-align: right;
    font-weight: 700;
    color: var(--color-primary);
}

/* Ramazon Info Grid */
.ramadan-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}
.info-item strong {
    color: var(--color-secondary);
}

/* Maxsus holatlar */
.hidden {
    display: none;
}
.hidden-timer {
    display: none;
}
.special-day {
    font-weight: 700;
    color: #ffd933; /* Yorqin Oltin */
    background: rgba(255, 215, 0, 0.15);
    border-radius: 5px;
    padding: 2px 5px;
}
.current-prayer {
    background: var(--color-primary); 
    color: var(--color-navy) !important; 
    font-weight: bold;
}

/* Responsive (Kichik ekranlar uchun) */
@media (max-width: 768px) {
    body { font-size: 16px; }
    header { flex-direction: column; }
    nav a { margin: 5px 10px; }
    .prayer-header { flex-direction: column; align-items: flex-start; }
    .countdown-timers { flex-direction: column; }
    .countdown-display { font-size: 3em; }
    .btn { width: 90%; margin: 10px auto; display: block; }
}
    </style>
</head>
<body>

    <div id="subscription-modal" class="modal">
        <div class="modal-content glass-card">
            <h2>Saytga Kirish üîí</h2>
            <p class="large-text"><strong>Saytni ochish uchun bizning Telegram kanalimizga obuna bo‚Äòling.</strong></p>
            <p>Telegram kanalimiz: <strong class="telegram-id">@Raimjonov_28</strong></p>
            <a href="https://t.me/Raimjonov_28" target="_blank" class="btn btn-telegram">1. Telegramga O'tish</a>
            <button id="verify-subscription" class="btn btn-primary" disabled>2. Obunani Tasdiqlash</button>
            <p class="small-text">*Majburiy qadam. Avval Telegramga o'tib, 5 soniya kuting.</p>
        </div>
    </div>

    <div id="main-content" class="hidden">
        
        <header id="main-header">
            <h1 class="logo">Oson Taqvim üïå</h1>
            <nav>
                <a href="#namoz">Namoz Vaqtlari</a>
                <a href="#taqvim">Ramazon Jadvali</a>
            </nav>
        </header>

        <main class="container">

            <section id="namoz" class="prayer-times-section">
                <div class="prayer-header">
                    <h2 class="section-title">Bugungi namoz vaqtlari <span id="current-city-name">(Samarqand)</span></h2>
                    
                    <div class="location-control">
                        <label for="location-selector">Viloyatni tanlang:</label>
                        <select id="location-selector" class="dropdown">
                            </select>
                    </div>
                </div>

                <div class="countdown-timers">
                    <div class="timer-card glass-card large-timer">
                        <p>Keyingi vaqtgacha qoldi:</p>
                        <div id="next-prayer-countdown" class="countdown-display">00:00:00</div>
                    </div>
                    
                    <div id="iftar-countdown-card" class="timer-card glass-card hidden-timer large-timer">
                        <p>Iftorlikgacha qoldi:</p>
                        <div id="iftar-countdown" class="countdown-display">--:--:--</div>
                    </div>
                </div>

                <div class="prayer-table-container glass-card">
                    <table class="simple-table">
                        <thead><tr><th>Namoz nomi</th><th>Vaqti</th></tr></thead>
                        <tbody id="prayer-times-body">
                            <tr><td>Saharlik (Tong)</td><td data-time="Imsak">--:--</td></tr>
                            <tr><td>Bomdod</td><td data-time="Fajr">--:--</td></tr>
                            <tr><td>Quyosh</td><td data-time="Sunrise">--:--</td></tr>
                            <tr><td>Peshin</td><td data-time="Dhuhr">--:--</td></tr>
                            <tr><td>Asr</td><td data-time="Asr">--:--</td></tr>
                            <tr><td>Shom (Iftor)</td><td data-time="Maghrib">--:--</td></tr>
                            <tr><td>Xufton</td><td data-time="Isha">--:--</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <hr>

            <section id="taqvim">
                <div class="taqvim-controls glass-card">
                    <h2>üóì Ramazon Taqvimi (2026-yil)</h2>
                    
                    <div id="ramadan-info" class="ramadan-info-grid">
                        <div class="info-item"><strong>Boshlanish:</strong> <span id="start-date">18 Fevral</span></div>
                        <div class="info-item"><strong>Tugash:</strong> <span id="end-date">19 Mart</span></div>
                        <div class="info-item"><strong>Ro‚Äòza kuni:</strong> <span id="fast-days">--</span></div>
                        <div class="info-item"><strong>Yil tanlash:</strong> 
                            <select id="year-selector" class="dropdown small-dropdown">
                                </select>
                        </div>
                    </div>
                    <p class="ramadan-note">* Namoz vaqtlarining farqi har bir viloyat markazi uchun taxminan +/- 1-5 daqiqa bo‚Äòlishi mumkin.</p>
                </div>
                

                <div class="taqvim-table-container glass-card">
                    <h3>Ro‚Äòza kunlari jadvali</h3>
                    <table id="ramadan-calendar" class="wide-table">
                        <thead>
                            <tr>
                                <th>Ro‚Äòza Kuni</th>
                                <th>Sanasi</th>
                                <th>Saharlik (Imsak)</th>
                                <th>Iftorlik (Shom)</th>
                                <th>Izoh</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </section>

        </main>

        <footer>
            <div class="container">
                <p>&copy; 2025. Barcha huquqlar himoyalangan. Dasturchi: <a href="https://t.me/Raimjonov_28" target="_blank">@Raimjonov_28</a></p>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

    const API_URL_BASE = 'https://api.aladhan.com/v1/';
    const locationSelector = document.getElementById('location-selector');

    // --- RAMAZON VAQTLARI ANIQ MA'LUMOTLARI (2026-yil) ---
    const RAMADAN_YEAR = 2026;
    
    // JS Date obyektida oylar 0 dan boshlanadi (1=Fevral, 2=Mart)
    const RAMADAN_START_MONTH_JS = 1; 
    const RAMADAN_START_DAY = 18;     // 18-Fevral
    
    const RAMADAN_END_MONTH_JS = 2;   
    const RAMADAN_END_DAY = 19;       // 19-Mart

    const RAMADAN_START_DATE = new Date(RAMADAN_YEAR, RAMADAN_START_MONTH_JS, RAMADAN_START_DAY); 
    const RAMADAN_END_DATE = new Date(RAMADAN_YEAR, RAMADAN_END_MONTH_JS, RAMADAN_END_DAY);   

    // --- VILOYATLAR RO'YXATI (o'zgarishsiz) ---\
    const UZBEK_CITIES = [
        { name: "Toshkent", value: "Tashkent" },
        { name: "Samarqand", value: "Samarkand" },
        { name: "Buxoro", value: "Bukhara" },
        { name: "Andijon", value: "Andijan" },
        { name: "Namangan", value: "Namangan" },
        { name: "Farg'ona", value: "Fergana" },
        { name: "Xiva", value: "Khiva" },
        { name: "Termiz", value: "Termez" },
        { name: "Qarshi", value: "Karshi" },
        { name: "Nukus", value: "Nukus" },
        { name: "Jizzax", value: "Jizzakh" },
        { name: "Urganch", value: "Urgench" }
    ];

    // --- NAMOS VAQTLARI ANIQ MA'LUMOTLARI (Statik Baza - o'zgarishsiz) ---
    const STATIC_PRAYER_TIMES = {
        Fajr: "06:04", Sunrise: "07:27", Dhuhr: "12:12", Asr: "15:14",       
        Maghrib: "16:58", Isha: "18:19", Imsak: "05:45"      
    };

    // --- NAMOS ESLATM–êSI UCHUN O'ZGURVCHILAR (o'zgarishsiz) ---
    let lastNotifiedPrayer = ''; 
    let notificationPermission = Notification.permission;
    const audioAlert = new Audio('https://www.soundjay.com/buttons/beep-01a.mp3'); 


    // --- MODALNI BOSHQARISH ---
    const modal = document.getElementById('subscription-modal');
    const mainContent = document.getElementById('main-content');
    const verifyButton = document.getElementById('verify-subscription');
    const telegramLink = document.querySelector('.btn-telegram');
    
    // Obunani tekshirish funksiyasi (24 soatlik tekshiruv)
    function checkSubscriptionStatus() {
        const lastVerifiedTime = localStorage.getItem('lastVerifiedTime');
        const now = new Date().getTime();
        // Obuna 24 soat (86400000 millisekund) davomida amal qiladi
        const VALID_DURATION = 86400000; 

        if (lastVerifiedTime && (now - lastVerifiedTime < VALID_DURATION)) {
            return true;
        }
        // Obuna muddati tugagan yoki hech qachon qilinmagan bo'lsa, o'chiramiz
        localStorage.removeItem('lastVerifiedTime');
        localStorage.removeItem('hasClickedTelegram');
        return false;
    }
    
    let hasClickedTelegram = localStorage.getItem('hasClickedTelegram') === 'true'; 
    let isSubscribed = checkSubscriptionStatus(); 

    // Saytga kirish/bloklash mantig'i 
    if (!isSubscribed) {
        modal.classList.remove('hidden');
        mainContent.classList.add('hidden');
        if (!hasClickedTelegram) {
            verifyButton.disabled = true;
            verifyButton.textContent = "2. Obuna bo'lish uchun Telegramga o'ting";
        }
    } else {
        modal.classList.add('hidden');
        mainContent.classList.remove('hidden');
        initMainFunctions();
    }

    // Telegram linkini bosish hodisasi 
    telegramLink.addEventListener('click', () => {
        if (!hasClickedTelegram) {
            localStorage.setItem('hasClickedTelegram', 'true');
            hasClickedTelegram = true;
            
            verifyButton.textContent = "2. Iltimos, 5 soniya kuting...";
            verifyButton.disabled = true;

            setTimeout(() => {
                verifyButton.disabled = false;
                verifyButton.textContent = "2. Obunani Tasdiqlash"; 
            }, 5000); 
        }
    });

    // Tekshirish tugmasini bosish hodisasi
    verifyButton.addEventListener('click', () => {
        if (verifyButton.disabled) {
            alert("Iltimos, avval '1. Telegramga O'tish' tugmasini bosing va 5 soniya kuting.");
            return;
        }

        if (hasClickedTelegram) {
            // Obunani tasdiqlash vaqti va holatini saqlash
            localStorage.setItem('lastVerifiedTime', new Date().getTime());
            
            modal.classList.add('hidden');
            mainContent.classList.remove('hidden');
            initMainFunctions();
            requestNotificationPermission(); 
            alert("Xush kelibsiz! Saytdan foydalanishingiz mumkin. (24 soat amal qiladi)");
        }
    });
    
    // Xabarnoma so'rash funksiyasi (o'zgarishsiz)
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
                notificationPermission = permission;
                if (permission === 'granted') {
                    new Notification("Eslatma: Namoz vaqtlari eslatmasini yoqdingiz", {
                        body: "Namoz vaqti kelganda sizni ogohlantiramiz!"
                    });
                }
            });
        }
    }

    // ASOSIY FUNKSIYALARNI ISHGA TUSHIRISH (o'zgarishsiz)
    function initMainFunctions() {
        populateSelectors(); 
        setupEventListeners();
        
        const initialYear = document.getElementById('year-selector').value || RAMADAN_YEAR;
        generateRamadanCalendar(initialYear);
        fetchPrayerTimes(); 
        setInterval(updateCountdown, 1000); 
    }

    // SELECTORLARNI TO'LDIRISH (o'zgarishsiz)
    function populateSelectors() {
        UZBEK_CITIES.forEach(city => {
            const option = document.createElement('option');
            option.value = city.value;
            option.textContent = city.name;
            if (city.value === 'Samarkand') { option.selected = true; }
            locationSelector.appendChild(option);
        });

        const yearSelector = document.getElementById('year-selector');
        for (let year = 2025; year <= 2050; year++) {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            if (year === RAMADAN_YEAR) { option.selected = true; }
            yearSelector.appendChild(option);
        }
    }

    function setupEventListeners() {
        document.getElementById('year-selector').addEventListener('change', (e) => {
            generateRamadanCalendar(e.target.value);
        });
        locationSelector.addEventListener('change', () => {
             fetchPrayerTimes(); 
             generateRamadanCalendar(document.getElementById('year-selector').value);
        });
    }

    // --- RAMAZON TAQVIMINI GENERATSIYA QILISH ---
    async function generateRamadanCalendar(year) {
        const calendarBody = document.querySelector('#ramadan-calendar tbody');
        calendarBody.innerHTML = '';
        
        if (parseInt(year) !== RAMADAN_YEAR) {
            calendarBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">${year}-yil Ramazon taqvimi hali e'lon qilinmagan.</td></tr>`;
            document.getElementById('start-date').textContent = '---';
            document.getElementById('end-date').textContent = '---';
            document.getElementById('fast-days').textContent = '---';
            return;
        }
        
        const locationValue = locationSelector.value;
        
        const startDay = new Date(RAMADAN_START_DATE);
        const endDay = new Date(RAMADAN_END_DATE);
        
        const daysInRamadan = Math.round((endDay - startDay) / (1000 * 60 * 60 * 24)) + 1;

        // Boshlanish va tugash sanalarini Oy va Kun bilan formatlash
        const options = { month: 'long', day: 'numeric' };
        
        document.getElementById('start-date').textContent = startDay.toLocaleDateString('uz-UZ', options);
        document.getElementById('end-date').textContent = endDay.toLocaleDateString('uz-UZ', options); 
        document.getElementById('fast-days').textContent = daysInRamadan;


        for (let i = 0; i < daysInRamadan; i++) {
            const currentDate = new Date(startDay);
            currentDate.setDate(startDay.getDate() + i);

            const dateISO = currentDate.toLocaleDateString('en-CA');
            const dailyAPI = `${API_URL_BASE}timingsByCity/${dateISO}?city=${locationValue}&country=Uzbekistan&method=1`; 

            let iftorTime = STATIC_PRAYER_TIMES.Maghrib;
            let imsakTime = STATIC_PRAYER_TIMES.Imsak;
            
            try {
                const response = await fetch(dailyAPI);
                const data = await response.json();
                
                if (data.code === 200) {
                    const timings = data.data.timings;
                    iftorTime = timings.Maghrib ? timings.Maghrib.substring(0, 5) : STATIC_PRAYER_TIMES.Maghrib;
                    imsakTime = timings.Imsak ? timings.Imsak.substring(0, 5) : STATIC_PRAYER_TIMES.Imsak;
                }
            } catch (e) {
                console.warn(`Ramazon vaqti yuklanmadi (${dateISO}). Statik vaqtlar ishlatilmoqda.`);
            }

            let izoh = '';
            if (i + 1 === daysInRamadan) { izoh = 'üåô Ramazon Hayiti kuni'; }
            else if (i + 1 === 27) { izoh = 'üåü Qadr kechasi (Afzal)'; }
            else if (i + 1 >= daysInRamadan - 9 && (i + 1) % 2 !== 0) { izoh = 'Laylatul Qadr (Taxmin)'; }

            // Talab qilingan format: "Fevral 18" (Oy Kun) ko'rinishi
            const formattedDate = currentDate.toLocaleDateString('uz-UZ', options); 

            const row = calendarBody.insertRow();
            row.innerHTML = `
                <td>${i + 1}-kun</td>
                <td>${formattedDate}</td>
                <td>${imsakTime}</td>
                <td>${iftorTime}</td>
                <td class="${izoh ? 'special-day' : ''}">${izoh}</td>
            `;
        }
        window.currentHijriMonth = 9; 
    }

    // --- Qolgan funksiyalar (fetchPrayerTimes, updatePrayerTimesUI, updateCountdown) o'zgarishsiz qoladi ---
    async function fetchPrayerTimes() {
        const locationName = locationSelector.options[locationSelector.selectedIndex].textContent;
        const locationValue = locationSelector.value;
        document.getElementById('current-city-name').textContent = `(${locationName})`;

        const date = new Date().toLocaleDateString('en-CA');
        const API_URL = `${API_URL_BASE}timingsByCity/${date}?city=${locationValue}&country=Uzbekistan&method=1`; 

        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            if (data.code === 200) {
                const timings = data.data.timings;
                const apiTimings = {
                    Fajr: timings.Fajr.substring(0, 5),
                    Sunrise: timings.Sunrise.substring(0, 5),
                    Dhuhr: timings.Dhuhr.substring(0, 5),
                    Asr: timings.Asr.substring(0, 5),
                    Maghrib: timings.Maghrib.substring(0, 5),
                    Isha: timings.Isha.substring(0, 5),
                    Imsak: timings.Imsak.substring(0, 5)
                };
                
                window.prayerTimings = apiTimings;
                updatePrayerTimesUI(apiTimings);
                window.currentHijriMonth = parseInt(data.data.date.hijri.month.number);
            } else {
                 throw new Error("API xatosi: Vaqtlar yuklanmadi.");
            }
        } catch (e) {
            console.error("API xato, statik vaqtlar ishlatilmoqda:", e);
            window.prayerTimings = STATIC_PRAYER_TIMES;
            updatePrayerTimesUI(STATIC_PRAYER_TIMES);
            window.currentHijriMonth = 0; 
        }
    }

    function updatePrayerTimesUI(timings) {
        document.querySelector('[data-time="Imsak"]').textContent = timings.Imsak;
        document.querySelector('[data-time="Fajr"]').textContent = timings.Fajr; 
        document.querySelector('[data-time="Sunrise"]').textContent = timings.Sunrise; 
        document.querySelector('[data-time="Dhuhr"]').textContent = timings.Dhuhr;
        document.querySelector('[data-time="Asr"]').textContent = timings.Asr;
        document.querySelector('[data-time="Maghrib"]').textContent = timings.Maghrib; 
        document.querySelector('[data-time="Isha"]').textContent = timings.Isha;
    }

    function formatTime(diff) {
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function sendPrayerAlert(prayerName) {
        if (notificationPermission === 'granted') {
            const bodyText = `Ey birodar, namoz vaqti bo'ldi! ${prayerName} namozini o'qing.`;
            new Notification(`üïå Namoz Vaqti Keldi!`, {
                body: bodyText,
                icon: 'https://img.icons8.com/color/48/mosque.png' 
            });
        }
        audioAlert.play();
    }


    function updateCountdown() {
        if (!window.prayerTimings) return;

        const now = new Date();
        const times = window.prayerTimings;
        
        const IS_RAMADAN = now >= RAMADAN_START_DATE && now <= RAMADAN_END_DATE; 

        const iftarCard = document.getElementById('iftar-countdown-card');
        if (IS_RAMADAN) {
            iftarCard.classList.remove('hidden-timer');
        } else {
            iftarCard.classList.add('hidden-timer');
        }

        const prayerKeys = ["Imsak", "Fajr", "Sunrise", "Dhuhr", "Asr", "Maghrib", "Isha"];
        
        const dailyPrayers = prayerKeys.map(key => {
            const timeStr = times[key];
            const [h, m] = timeStr.split(':');
            let dateObj = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(h), parseInt(m), 0);
            return { name: key, time: dateObj };
        });

        let nextPrayerTime = null;
        let nextPrayerName = null;
        let foundNext = false;
        
        for (const prayer of dailyPrayers) {
            const diff = prayer.time.getTime() - now.getTime();
            
            if (diff >= -60000 && diff < 60000 && lastNotifiedPrayer !== prayer.name) { 
                sendPrayerAlert(
                    prayer.name === 'Imsak' ? 'Saharlik tugashi' : 
                    (prayer.name === 'Maghrib' ? 'Iftorlik/Shom' : prayer.name)
                );
                lastNotifiedPrayer = prayer.name;
            }

            if (diff > 1000 && !foundNext) { 
                nextPrayerTime = prayer.time;
                nextPrayerName = prayer.name;
                foundNext = true;
                if (lastNotifiedPrayer === prayer.name) {
                     lastNotifiedPrayer = ''; 
                }
            }
        }
        
        if (!nextPrayerTime) {
            const tomorrowImsak = new Date(dailyPrayers[0].time);
            tomorrowImsak.setDate(tomorrowImsak.getDate() + 1);
            nextPrayerTime = tomorrowImsak;
            nextPrayerName = 'Imsak';
        }
        
        const timeDifference = nextPrayerTime.getTime() - now.getTime();
        document.getElementById('next-prayer-countdown').textContent = formatTime(timeDifference);
        
        document.querySelectorAll('#prayer-times-body tr').forEach(row => row.classList.remove('current-prayer'));
        const nextRow = document.querySelector(`#prayer-times-body td[data-time="${nextPrayerName}"]`).closest('tr');
        if (nextRow) {
            nextRow.classList.add('current-prayer');
        }

        if (IS_RAMADAN) {
            const iftarTimeStr = times.Maghrib; 
            const [iftarH, iftarM] = iftarTimeStr.split(':');
            let iftarTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), parseInt(iftarH), parseInt(iftarM), 0);
             
            if (iftarTime.getTime() - now.getTime() < 1000) {
                iftarTime.setDate(iftarTime.getDate() + 1);
            }
             
            const iftarDifference = iftarTime.getTime() - now.getTime();
            document.getElementById('iftar-countdown').textContent = formatTime(iftarDifference);
        }
    }
});
    </script>
</body>
</html>
